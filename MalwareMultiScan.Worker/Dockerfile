FROM mcr.microsoft.com/dotnet/core/sdk:3.1 AS builder

WORKDIR /src

COPY MalwareMultiScan.Worker /src/MalwareMultiScan.Worker
COPY MalwareMultiScan.Shared /src/MalwareMultiScan.Shared
COPY MalwareMultiScan.Backends /src/MalwareMultiScan.Backends

RUN dotnet publish -c Release -r linux-x64 /p:PublishSingleFile=true -o ./publish \
    MalwareMultiScan.Worker/MalwareMultiScan.Worker.csproj

FROM mcr.microsoft.com/dotnet/core/aspnet:3.1

WORKDIR /worker

COPY --from=builder /src/publish /worker

ENV ASPNETCORE_ENVIRONMENT=Production
ENV ASPNETCORE_URLS=http://+:9901

ENTRYPOINT ["/worker/MalwareMultiScan.Worker"]