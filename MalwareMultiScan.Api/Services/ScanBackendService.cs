using System;
using System.IO;
using System.Threading.Tasks;
using EasyNetQ;
using MalwareMultiScan.Api.Data.Configuration;
using MalwareMultiScan.Api.Data.Models;
using MalwareMultiScan.Shared.Data.Messages;
using Microsoft.Extensions.Configuration;
using YamlDotNet.Serialization;
using YamlDotNet.Serialization.NamingConventions;

namespace MalwareMultiScan.Api.Services
{
    public class ScanBackendService
    {
        private readonly IBus _bus;

        public ScanBackendService(IConfiguration configuration, IBus bus)
        {
            _bus = bus;
            
            var configurationPath = configuration.GetValue<string>("BackendsConfiguration");

            if (!File.Exists(configurationPath))
                throw new FileNotFoundException("Missing BackendsConfiguration YAML file", configurationPath);

            var configurationContent = File.ReadAllText(configurationPath);

            var deserializer = new DeserializerBuilder()
                .WithNamingConvention(CamelCaseNamingConvention.Instance)
                .Build();

            List = deserializer.Deserialize<ScanBackend[]>(configurationContent);
        }

        public ScanBackend[] List { get; }
        
        public async Task QueueUrlScan(ScanResult result, ScanBackend backend, string fileUrl)
        {
            await _bus.SendAsync(backend.Id, new ScanRequestMessage
            {
                Id = result.Id,
                Uri = new Uri(fileUrl)
            });
        }
    }
}